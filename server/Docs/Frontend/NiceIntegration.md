# Frontend Handling of NICE Self-Identification Callbacks

This document outlines how the frontend application should handle the redirect callbacks from the NICE self-identification service via our backend.

## 1. Overview

After the user completes the NICE self-identification process (or if it fails), NICE redirects back to our backend's `/nice/checkplus/success` or `/nice/checkplus/fail` endpoints. The backend processes this information, stores relevant data temporarily, and then redirects the user's browser to a pre-configured frontend URL (`frontend-redirect-success-url` or `frontend-redirect-fail-url` from backend configuration).

This redirect to the frontend will include several query parameters that the frontend must parse and use to determine the next steps.

## 2. Callback URL Query Parameters

The frontend page loaded via the redirect will have URL query parameters. Here are the key parameters to expect:

### 2.1. Common Parameters

- `status`: (String) Indicates the overall outcome from the backend's perspective.
  - `"success"`: The NICE process was successful, and the backend has processed the data.
  - `"fail"`: The NICE process failed, or an error occurred in the backend while processing the NICE data.
- `key`: (String) A unique key generated by the backend. This key is crucial for fetching the detailed verification results (or error details) from the backend API endpoint `/api/v1/nice/checkplus/result/{key}` (Note: The actual API prefix like `/api/v1` might vary based on backend routing rules; ensure this matches the deployed API structure. The controller path is `/nice/checkplus/result/{key}`).

### 2.2. Parameters on Successful Backend Processing (`status="success"`)

When `status` is `"success"`, the following additional parameters might be present:

- `joined`: (String, optional) Indicates if the DI (Distinguishing Information) from the NICE verification is already associated with an existing user account.
  - `"true"`: An existing user was found with this DI.
  - `"false"` or absent: No existing user was found with this DI (this state is typically implied if `nice_error_code` is not `DUPLICATE_DI`).
- `username`: (String, optional) If `joined` is `"true"`, this _may_ contain the username of the existing account. This can be used to help the user log in.
- `nice_error_code`: (String, optional) Indicates a specific condition or error encountered during the backend's post-verification checks, even if the NICE process itself was successful.
  - `"DUPLICATE_DI"`: This specific code means the DI returned by NICE is already linked to an existing user account. This is a key flag for the frontend to handle a specific user flow.

**Example Success URLs:**

- New user, ready for signup:
  `https://your-frontend.com/nice-callback?status=success&key=uniqueResultKey123`
- Existing user found (DI duplicate):
  `https://your-frontend.com/nice-callback?status=success&key=uniqueResultKey456&joined=true&username=existinguser123&nice_error_code=DUPLICATE_DI`

### 2.3. Parameters on Failed Backend Processing (`status="fail"`)

When `status` is `"fail"`, the following additional parameters might be present in addition to `status` and `key`:

- `error`: (String, optional) A general error code from the backend (e.g., `"processing_failed"`).
- `detail`: (String, optional) A more detailed error message or exception type from the backend.

**Example Fail URL:**

`https://your-frontend.com/nice-callback?status=fail&key=errorKey789&error=processing_failed&detail=NiceApiException:ErrorParsingResponse`

## 3. Frontend Logic Flow

Upon loading the callback page, the frontend should:

1.  **Parse URL Query Parameters**: Extract all relevant parameters (`status`, `key`, `joined`, `username`, `nice_error_code`, etc.).

2.  **Check `status` parameter**:

    - **If `status === "success"`**:

      1.  **Check for `nice_error_code === "DUPLICATE_DI"`**:
          - If present, this takes precedence. Inform the user that their identity is already registered in the system.
          - Display a message like: "This identity is already registered. Please log in with your existing account."
          - If the `username` parameter is also present, you can suggest it to the user (e.g., "Are you `existinguser123`?").
          - Provide a clear link/button to the login page.
          - Do **not** proceed to the signup form with this identity.
      2.  **Else (no `DUPLICATE_DI` error code)**:
          - This means the user is likely new or the DI is not yet registered.
          - Proceed to the user signup page/flow.
          - Use the `key` parameter to make an **asynchronous GET request** to the backend API endpoint `/api/v1/nice/checkplus/result/{key}` to fetch the verified user data (`NicePublicUserDataDto`).
          - On successful fetch:
            - Pre-fill the signup form with the received data (e.g., name, birth date, gender, phone number).
            - Store the `key` (the one received in the URL, which is `resultKey` for the NICE data) in the signup form (e.g., as a hidden field named `niceResultKey`). This key will be submitted with the signup form to link the signup attempt to the verified NICE data.
          - On failed fetch (e.g., key expired, not found): Display an appropriate error message (e.g., "Failed to retrieve verification details. Please try again.") and potentially redirect to an error page or the start of the NICE process.

    - **If `status === "fail"`**:
      1.  An error occurred either during the NICE process itself or during backend processing of the NICE callback.
      2.  The frontend should display a user-friendly error message.
      3.  Optionally, use the `key` to make a GET request to `/api/v1/nice/checkplus/result/{key}`. The backend might store a `NiceErrorDataDto` or a generic error structure associated with this key, which could provide more specific error details from NICE (e.g., error code from NICE, message).
      4.  Based on the error, guide the user (e.g., "Self-identification failed. Please try again." or provide more specific instructions if available from the error details).
      5.  Provide a link/button to retry the self-identification process.

## 4. Fetching Verification Data/Error Details

When the frontend needs to get the details associated with a `key` (either successful user data or error information), it should make a GET request to:

`/api/v1/nice/checkplus/result/{key}` (adjust API prefix if necessary)

- **On Success (`status="success"`, no `DUPLICATE_DI` error code from URL):**
  - The expected response is a JSON object matching `NicePublicUserDataDto` containing fields like `name`, `birthDate`, `gender`, `mobileNo`, etc.
  - Use this data to pre-fill the signup form.
- **On Fail (`status="fail"` from URL):**
  - The response could be a `NiceErrorDataDto` or a generic error JSON.
  - Use this to display a more informative error message.
- **If the key is invalid, expired, or already consumed inappropriately:**
  - The endpoint should return an appropriate HTTP status code (e.g., 404 Not Found, 400 Bad Request) with an error message.

## 5. Important Considerations

- **Security**: The `key` is a short-lived token. The actual sensitive DI data is not passed through the frontend directly after the initial NICE interaction. The frontend uses the `key` to request public-facing (or signup-relevant) data from the backend.
- **User Experience**: Provide clear messages and guidance to the user at each step, especially for error conditions or when an existing account is detected.
- **API Endpoint Consistency**: Ensure the frontend uses the correct backend API endpoint (`/api/v1/nice/checkplus/result/{key}`) for fetching data. The path `/nice/checkplus/result/{key}` is defined in `NiceController` but actual exposure might be under `/api/v1` or other prefixes depending on global servlet/filter configurations.

This flow ensures that duplicate registrations via NICE are handled gracefully by informing the user and guiding them to login, while new users can proceed to signup with pre-filled, verified information.
